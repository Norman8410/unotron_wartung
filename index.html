<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430 - DEBUG</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        /* CSS-Stile bleiben unver√§ndert */
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-workload { background: var(--bosch-blue); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.1em; margin-left: 20px;}
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; padding: 20px; flex: 1; overflow-y: auto; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; min-height: 400px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: var(--bosch-blue); display: flex; align-items: center; gap: 5px; }
        .col-header a:hover { color: var(--bosch-red); }
        .time-badge { font-size: 0.8em; color: var(--bosch-red); background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #ffcccc; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .no-data { text-align: center; color: #999; padding-top: 50px; font-style: italic; }
        .card { padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #eee; }
        .card.warning { background-color: #fff3cd; border-left: 8px solid #ffc107; }
        .card.critical { background-color: #f8d7da; border-left: 8px solid #dc3545; }
        .card.overdue { background-color: #f5b7b1; border-left: 8px solid #b03a2e; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="top-bar">Zentrales Wartungs Dashboard W430 - DEBUG-MODUS</div>
    <div class="header">
        <div style="display:flex; align-items:center;">
            <span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> 
            <div id="overall-workload" class="total-workload">Lade...</div>
        </div>
        <div><button class="nav-btn" onclick="auth.signOut()">Logout</button></div>
    </div>
    <div class="dashboard-grid">
        <div class="column"><div class="col-header"><a href="agie.html" target="_blank">‚ö° Agie</a><div id="count-agie"></div></div><div class="machine-list" id="list-agie"></div></div>
        <div class="column"><div class="col-header"><a href="unotron.html" target="_blank">üß™ Unotron</a><div id="count-uno"></div></div><div class="machine-list" id="list-uno"></div></div>
        <div class="column"><div class="col-header"><a href="he.html" target="_blank">‚öôÔ∏è HE</a><div id="count-he"></div></div><div class="machine-list" id="list-he"></div></div>
        <div class="column"><div class="col-header"><a href="laser.html" target="_blank">üí° Laser</a><div id="count-laser"></div></div><div class="machine-list" id="list-laser"></div></div>
        <div class="column"><div class="col-header"><a href="waschanlagen.html" target="_blank">üíß Waschanlagen</a><div id="count-wasch"></div></div><div class="machine-list" id="list-wasch"></div></div>
        <div class="column"><div class="col-header"><a href="pruefgeraete.html" target="_blank">üîç Pr√ºfger√§te</a><div id="count-pruef"></div></div><div class="machine-list" id="list-pruef"></div></div>
        <div class="column"><div class="col-header"><a href="lager.html" target="_blank">üì¶ Lager & Regale</a><div id="count-lager"></div></div><div class="machine-list" id="list-lager"></div></div>
    </div>

<script>
    console.log("--- SCRIPT START ---");

    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    
    let state = {};

    const kwGroups = {
        wasch: ['silberhorn', 'ministar'],
        pruef: ['sichtpruefstaende', 'sichtpruefplaetze', 'einstellgeraetNek'],
        lager: ['unotronAblieferregal', 'entkopplungsregal', 'waschregal', 'oellager']
    };

    console.log("Firebase initialisiert. Setze Listener...");

    const paths = {
        maintConfig: 'maintenanceConfig',
        maintenanceState: 'maintenanceState',
        maintenanceStateHE: 'maintenanceStateHE',
        maintenanceStateUnotron: 'maintenanceStateUnotron',
        maintenanceStateLaser: 'maintenanceStateLaser',
        maintenanceStateKW: 'maintenanceStateKW'
    };

    Object.keys(paths).forEach(key => {
        db.ref(paths[key]).on('value', s => {
            console.log(`Daten f√ºr '${key}' empfangen:`, s.val());
            state[key] = s.val() || {};
            updateUI();
        }, err => console.error(`Fehler beim Laden von '${key}':`, err));
    });

    function getWeek() { const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()+3-(d.getDay()+6)%7);const w1=new Date(d.getFullYear(),0,4);return 1+Math.round(((d-w1)/86400000-3+(w1.getDay()+6)%7)/7);}
    function formatTime(m) { return m > 0 ? `${m} Min` : '0 Min'; }

    function renderCol(listId, rawData, cfg, prefix) {
        console.log(`Render Col f√ºr ${listId} mit Prefix ${prefix}`);
        if (!rawData || !rawData.cloudRawData || !cfg) {
            console.warn(`Fehlende Daten f√ºr ${listId}:`, {rawData, cfg});
            document.getElementById(listId).innerHTML = '<div class="no-data">Konfig. oder Live-Daten fehlen</div>';
            return [];
        }
        
        const filteredData = rawData.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO;
            const stand = parseInt(item.Parts || item["COUNT(*)"]) || 0;
            if (!sId) return null;

            const ist = stand - ((rawData.agieOffsets && rawData.agieOffsets[sId]) || 0);
            const step = (cfg.steps && cfg.steps[0]) || {target: cfg.maxLimit, pkg: "RESET"};
            const rest = step.target - ist;
            
            if (rest <= (cfg.warn || 5000)) {
                return { id: prefix + sId, rest, pkg: step.pkg };
            }
            return null;
        }).filter(m => m);

        console.log(`Gefilterte Daten f√ºr ${listId}:`, filteredData);
        document.getElementById(listId).innerHTML = filteredData.length > 0 ? filteredData.map(m => `<div class="card">${m.id} - Rest: ${m.rest}</div>`).join('') : '<div class="no-data">Keine Wartungen</div>';
        return filteredData;
    }
    
    function renderKwGroup(listId, keys) {
        console.log(`Render KW Group f√ºr ${listId} mit Keys:`, keys);
        const currentWeek = getWeek();
        let allMachines = [];

        keys.forEach(key => {
            const cfg = state.maintConfig[key];
            const machineState = state.maintenanceStateKW[key];
            if (!cfg || !machineState) {
                console.warn(`Fehlende Daten f√ºr KW-Maschine '${key}':`, {cfg, machineState});
                return;
            }

            (cfg.machines || []).forEach(id => {
                const cyc = (machineState.extraCycles && machineState.extraCycles[id]) || 0;
                const step = (cfg.steps && cfg.steps[cyc]) || {target: cfg.yearlyResetWeek || 52, pkg: "JAHRES-RESET"};
                const rest = step.target - currentWeek;

                if (rest <= (cfg.warnWeeks || 4)) {
                    allMachines.push({ id: (cfg.prefix || key.substring(0,1).toUpperCase()) + id, rest, pkg: step.pkg });
                }
            });
        });
        
        console.log(`Gefilterte KW-Daten f√ºr ${listId}:`, allMachines);
        document.getElementById(listId).innerHTML = allMachines.length > 0 ? allMachines.map(m => `<div class="card">${m.id} - Rest: ${m.rest} Wo</div>`).join('') : '<div class="no-data">Keine Wartungen</div>';
        return allMachines;
    }


    function updateUI() {
        console.log("--- updateUI() wird aufgerufen ---");
        if (!state.maintConfig || !state.maintenanceState || !state.maintenanceStateUnotron) {
            console.log("Warte auf kritische Initialdaten (Config, Agie-State, Unotron-State)...");
            return;
        }
        
        console.log("Alle kritischen Daten vorhanden, starte Rendering...");
        
        renderCol('list-agie', state.maintenanceState, state.maintConfig.agie, 'A-');
        renderCol('list-uno', state.maintenanceStateUnotron, state.maintConfig.unotron, 'U-');
        renderCol('list-he', state.maintenanceStateHE, state.maintConfig.he, 'H-');
        renderCol('list-laser', state.maintenanceStateLaser, state.maintConfig.laser, 'L-');
        
        renderKwGroup('list-wasch', kwGroups.wasch);
        renderKwGroup('list-pruef', kwGroups.pruef);
        renderKwGroup('list-lager', kwGroups.lager);
    }
</script>

</body>
</html>
