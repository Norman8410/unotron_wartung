<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-dark-red: #8b0000; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Neuer Style f√ºr den zentralen Stunden-Z√§hler */
        .total-workload { background: var(--bosch-blue); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.1em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: var(--bosch-blue); transition: color 0.2s; display: flex; align-items: center; gap: 5px; }
        .col-header a:hover { color: var(--bosch-red); text-decoration: underline; }
        .time-badge { font-size: 0.8em; color: var(--bosch-red); background: white; padding: 2px 8px; border-radius: 12px; border: 1px solid #ffcccc; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .card { padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .card.warning { background-color: #fff3cd; border-left: 8px solid #ffc107; color: #856404; }
        .card.critical { background-color: #f8d7da; border-left: 8px solid #dc3545; color: #721c24; }
        .card.overdue { background-color: #f5b7b1; border-left: 8px solid #b03a2e; color: #641e16; }
        .card.in-progress { background-color: #d1ecf1 !important; border-left: 8px dashed #0c5460 !important; color: #0c5460; }
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .m-id { font-weight: bold; font-size: 1.2em; } .m-rest { font-weight: bold; font-size: 1.2em; } .m-paket { font-size: 0.9em; font-weight: bold; }
        .card-actions { display: flex; gap: 5px; margin-top: 8px; }
        select { flex: 1; padding: 6px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; background: white; }
        .btn-done { flex: 0 0 auto; padding: 0 10px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; font-weight: bold; cursor: pointer; background: white; color: var(--bosch-green); }
        .btn-done.reset-mode { color: var(--bosch-red); border-color: var(--bosch-red); }
        .btn-done:disabled { opacity: 0.4; cursor: not-allowed; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; padding: 25px; width: 350px; border-top: 8px solid var(--bosch-red); border-radius: 4px; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); border-radius: 4px; }
        .primary-btn { background: var(--bosch-blue); color: white; border: none; width: 100%; padding: 12px; cursor: pointer; font-weight: bold; border-radius: 4px; }
    </style>
</head>
<body onmousedown="resetInactivityTimer()">

<div class="top-bar">Zentrales Wartungs Dashboard W430</div>
<div class="header">
    <div style="display: flex; align-items: center; gap: 20px;">
        <span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> 
        <span style="font-weight:bold;color:#555;">Dashboard</span>
        <div id="overall-workload" class="total-workload">Wartungsaufwand: 0h</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="logDownloadBtn" class="nav-btn" style="display:none; border-color:var(--bosch-blue);" onclick="downloadLogs()">üìä Log Download</button>
        <button id="authBtn" class="nav-btn" onclick="toggleAuthModal()">üîë Login</button>
        <button class="nav-btn" onclick="openAdminModal()">‚öôÔ∏è Einsteller</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="column">
        <div class="col-header"><a href="agie.html" target="_blank">‚ö° Agie <span>‚ûî</span></a><div id="count-agie">0</div></div>
        <div class="machine-list" id="list-agie"></div>
    </div>
    <div class="column" style="border-top-color: var(--bosch-green);">
        <div class="col-header"><a href="unotron.html" target="_blank">üß™ Unotron <span>‚ûî</span></a><div id="count-uno">0</div></div>
        <div class="machine-list" id="list-uno"></div>
    </div>
    <div class="column" style="border-top-color: #8b0000;">
        <div class="col-header"><a href="unotron-auto.html" target="_blank">ü§ñ Unotron Auto <span>‚ûî</span></a><div id="count-uno-auto">0</div></div>
        <div class="machine-list" id="list-uno-auto"></div>
    </div>
    <div class="column" style="border-top-color: #007bc0;">
        <div class="col-header"><a href="he.html" target="_blank">‚öôÔ∏è HE <span>‚ûî</span></a><div id="count-he">0</div></div>
        <div class="machine-list" id="list-he"></div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    let state = { config:{}, assignments:{}, agie:{}, uno:{}, unoAuto:{}, he:{}, maintConfig: {} };
    
    // Globale Variable f√ºr die Berechnung der Gesamtstunden
    let totalOffenMinuten = 0;

    const unoGroups = {
        "100": [101, 102, 103, 104, 113, 114, 115, 116],
        "200": [117, 112, 111, 110, 109, 108, 107, 106],
        "300": [118, 119, 120, 121, 122, 123, 124, 125]
    };

    function updateUI() { 
        if(!state.maintConfig.agie || !state.uno.cloudRawData) return; 
        
        totalOffenMinuten = 0; // Reset f√ºr Neuberechnung

        // Spalten rendern (diese Funktionen erh√∂hen totalOffenMinuten)
        renderCol('list-agie', 'count-agie', state.agie, 'A', state.maintConfig.agie); 
        renderCol('list-uno', 'count-uno', state.uno, 'U', state.maintConfig.unotron); 
        
        // Unotron Auto Logik
        const rawUnotron = state.uno.cloudRawData || [];
        const autoRawList = [];
        Object.keys(unoGroups).forEach(groupId => {
            let sum = 0;
            unoGroups[groupId].forEach(stationId => {
                const match = rawUnotron.find(r => (r.STATIONNO || r.StationNo) == stationId);
                if (match) sum += (parseInt(match["COUNT(*)"] || match.Parts) || 0);
            });
            autoRawList.push({ StationNo: groupId, Parts: sum });
        });
        const autoState = { cloudRawData: autoRawList, unotronOffsets: state.unoAuto.unotronOffsets || {}, extraCycles: state.unoAuto.extraCycles || {} };
        renderCol('list-uno-auto', 'count-uno-auto', autoState, 'UA', state.maintConfig.unotronAuto);

        renderCol('list-he', 'count-he', state.he, 'H', state.maintConfig.he); 

        // Gesamtstunden anzeigen
        const h = Math.floor(totalOffenMinuten / 60);
        const m = totalOffenMinuten % 60;
        document.getElementById('overall-workload').innerText = `Wartungsaufwand: ${h}h ${m}m`;
    }

    function renderCol(listId, countId, raw, prefix, cfg) {
        if(!raw || !raw.cloudRawData || !cfg) return;
        let colMin = 0;
        const data = raw.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO || item.stationNo; 
            const aktuellerStand = parseInt(item.Parts || item["COUNT(*)"] || item.parts) || 0;
            let offK = (prefix === 'U' || prefix === 'UA') ? 'unotronOffsets' : (prefix === 'H' ? 'heOffsets' : 'agieOffsets');
            const offset = (raw[offK] && raw[offK][sId]) || 0;
            const cyc = (raw.extraCycles && raw.extraCycles[sId]) || 0;
            const ist = aktuellerStand - offset;
            const step = cfg.steps ? (cfg.steps[cyc] || { target: cfg.maxLimit, pkg: "RESET" }) : { target: cfg.maxLimit, pkg: "RESET" };
            const isOverMax = ist >= cfg.maxLimit;
            const rest = (isOverMax ? cfg.maxLimit : step.target) - ist;
            const dur = getDuration(isOverMax ? "RESET" : step.pkg, cfg.times);

            if (rest <= cfg.warn) {
                colMin += dur;
                totalOffenMinuten += dur; // Hier wird global aufsummiert
                return { id: prefix + "-" + sId, sId, rest, pkg: isOverMax ? "WP RESET" : step.pkg, dur, warn: cfg.warn, crit: cfg.crit, isReset: isOverMax, rawTotal: aktuellerStand };
            }
            return null;
        }).filter(m => m !== null).sort((a, b) => a.rest - b.rest);

        document.getElementById(countId).innerHTML = `<span>${data.length}</span> <span class="time-badge">‚è≥ ${Math.floor(colMin/60)}h ${colMin%60}m</span>`;
        document.getElementById(listId).innerHTML = data.map(m => {
            const ass = state.assignments[prefix + m.sId] || "";
            const isW = ass !== "";
            let cls = m.rest <= 0 ? 'overdue' : (m.rest <= m.crit ? 'critical' : 'warning');
            return `<div class="card ${cls} ${isW ? 'in-progress' : ''}"><div class="card-info"><div><div class="m-id">${m.id}</div><div class="m-paket">${m.pkg}</div><div class="m-time">‚è± ${m.dur} Min.</div></div><div class="m-rest">${m.rest.toLocaleString()}</div></div><div class="card-actions"><select ${!auth.currentUser ? 'disabled' : ''} onchange="handleEinstellerChange('${prefix}', '${m.sId}', this.value)"><option value="">-- Einsteller --</option>${(state.config.einstellerListe || []).map(e => `<option value="${e}" ${ass === e ? 'selected' : ''}>${e}</option>`).join('')}</select><button class="${m.isReset ? 'btn-done reset-mode' : 'btn-done'}" ${!auth.currentUser ? 'disabled' : ''} onclick="confirmMaint('${prefix}','${m.sId}',${m.isReset},${m.rawTotal})">${m.isReset ? 'üîÑ Reset' : '‚úÖ OK'}</button></div></div>`;
        }).join('');
    }

    function getDuration(p, t) { if(!p||p.includes("RESET")||!t) return 0; return p.split('/').reduce((a,c)=>{let k=c.toUpperCase().trim(); if(!k.startsWith("P"))k="P"+k; return a+(t[k]||0);},0); }
    
    // Firebase Listener
    db.ref('maintenanceConfig').on('value', s => { state.maintConfig = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.agie = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.uno = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotronAuto').on('value', s => { state.unoAuto = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.he = s.val() || {}; updateUI(); });
    db.ref('dashboardAssignments').on('value', s => { state.assignments = s.val() || {}; updateUI(); });
    db.ref('config').on('value', s => { state.config = s.val() || {}; updateUI(); });
    auth.onAuthStateChanged(u => { updateUI(); });
</script>
</body>
</html>
