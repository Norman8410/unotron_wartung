<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        /* --- Styles wie gehabt, plus Button-Styles --- */
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-dark-red: #8b0000; --bosch-work-yellow: #fff3cd; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: var(--bosch-blue); transition: color 0.2s; display: flex; align-items: center; gap: 5px; }
        .col-header a:hover { color: var(--bosch-red); text-decoration: underline; }
        .time-badge { font-size: 0.8em; color: var(--bosch-red); background: white; padding: 2px 8px; border-radius: 12px; border: 1px solid #ffcccc; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .card { padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.1s; }
        .card.warning { background-color: #fff3cd; border-left: 8px solid #ffc107; color: #856404; }
        .card.critical { background-color: #f8d7da; border-left: 8px solid #dc3545; color: #721c24; }
        .card.overdue { background-color: #f5b7b1; border-left: 8px solid #b03a2e; color: #641e16; }
        .card.in-progress { background-color: #d1ecf1 !important; border-left: 8px dashed #0c5460 !important; color: #0c5460; }
        @keyframes blink-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .blink { animation: blink-red 1s infinite; }
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .m-id { font-weight: bold; font-size: 1.2em; } .m-rest { font-weight: bold; font-size: 1.2em; } .m-paket { font-size: 0.9em; font-weight: bold; text-transform: uppercase; } .m-time { font-size: 0.8em; opacity: 0.8; margin-top: 4px; }
        
        /* Action Area Styles */
        .card-actions { display: flex; gap: 5px; margin-top: 8px; }
        select { flex: 1; padding: 6px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; background: white; cursor: pointer; }
        
        /* Der neue Button */
        .btn-done { flex: 0 0 auto; padding: 0 10px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; font-weight: bold; cursor: pointer; background: white; color: var(--bosch-green); transition: 0.2s; }
        .btn-done:hover:not(:disabled) { background: var(--bosch-green); color: white; border-color: var(--bosch-green); }
        .btn-done.reset-mode { color: var(--bosch-red); border-color: var(--bosch-red); }
        .btn-done.reset-mode:hover:not(:disabled) { background: var(--bosch-red); color: white; }
        .btn-done:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); background: #e0e0e0; color: #999; }

        /* Modale */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; padding: 25px; width: 350px; border-top: 8px solid var(--bosch-red); border-radius: 4px; }
        .form-group { margin-bottom: 15px; } .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); border-radius: 4px; }
        .primary-btn { background: var(--bosch-blue); color: white; border: none; width: 100%; padding: 12px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .link-btn { background: none; border: none; color: var(--bosch-blue); text-decoration: underline; cursor: pointer; margin-top: 15px; display: block; width: 100%; text-align: center; }

        /* Styling f√ºr die Einsteller-Liste */
        #adminEinstellerList li {
            padding: 6px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
        }
        #adminEinstellerList li:last-child {
            border-bottom: none;
        }
        #adminEinstellerList li:hover {
            background: #eef;
        }
    </style>
</head>
<body onmousedown="resetInactivityTimer()" onkeydown="resetInactivityTimer()">

<div class="top-bar">Zentrales Wartungs Dashboard W430</div>
<div class="header">
    <div><span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> <span style="font-weight:bold;margin-left:10px;color:#555;">Dashboard</span></div>
    <div style="display:flex; gap:10px;">
        <button id="authBtn" class="nav-btn" onclick="toggleAuthModal()">üîë Login</button>
        <button class="nav-btn" onclick="openAdminModal()">‚öôÔ∏è Einsteller</button>
    </div>
</div>

<div id="adminModal" class="modal">
    <div class="modal-box" style="width: 400px;">
        <h2 style="margin-top:0;">Einsteller Verwaltung</h2>
        
        <div id="adminLoginView">
            <div class="form-group">
                <label>Admin-Passwort</label>
                <input type="password" id="AdminPWInput" placeholder="Passwort eingeben">
            </div>
            <button class="primary-btn" onclick="checkAdminPW()">Entsperren</button>
        </div>

        <div id="adminManagerView" style="display:none;">
            <div style="max-height: 200px; overflow-y: auto; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                <ul id="adminEinstellerList" style="list-style: none; padding: 0; margin: 0;"></ul>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="newNachname" placeholder="Nachname" style="flex: 1;">
                <input type="text" id="newVorname" placeholder="Vorname" style="flex: 1;">
            </div>
            <button class="primary-btn" style="background: var(--bosch-green); margin-bottom: 10px;" onclick="addEinsteller()">‚ûï Hinzuf√ºgen</button>
        </div>

        <button class="link-btn" style="color:gray; text-decoration:none;" onclick="closeAdminModal()">Schlie√üen</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="column">
        <div class="col-header"><a href="https://norman8410.github.io/Wartungs-Dashboard-W430V3/agie.html" target="_blank">‚ö° Agie <span>‚ûî</span></a><div id="count-agie">0</div></div>
        <div class="machine-list" id="list-agie"></div>
    </div>
    <div class="column" style="border-top-color: var(--bosch-green);">
        <div class="col-header"><a href="https://norman8410.github.io/unotron-wartung/" target="_blank">üß™ Unotron <span>‚ûî</span></a><div id="count-uno">0</div></div>
        <div class="machine-list" id="list-uno"></div>
    </div>
    <div class="column" style="border-top-color: #007bc0;">
        <div class="col-header"><a href="https://norman8410.github.io/HE-Wartung/" target="_blank">‚öôÔ∏è HE <span>‚ûî</span></a><div id="count-he">0</div></div>
        <div class="machine-list" id="list-he"></div>
    </div>
</div>

<div id="authModal" class="modal"><div class="modal-box"><h2 id="modalTitle" style="margin-top:0;">Login</h2><div class="form-group"><input type="email" id="authEmail" placeholder="E-Mail"></div><div class="form-group"><input type="password" id="authPass" placeholder="Passwort"></div><div class="form-group" id="inviteGroup" style="display:none;"><input type="text" id="authInvite" placeholder="Einladungscode"></div><button class="primary-btn" id="mainAuthBtn" onclick="processAuth()">Anmelden</button><button class="link-btn" id="switchBtn" onclick="switchAuthMode()">Neu hier? Registrieren</button><button class="link-btn" style="color:gray; text-decoration:none;" onclick="toggleAuthModal()">Abbrechen</button></div></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    let state = { config:{}, assignments:{}, agie:{}, uno:{}, he:{}, maintConfig: {}, isRegMode: false };
    let inactivityTimer;

    // --- LOGIK: Wartung best√§tigen (Generisch) ---
    async function confirmMaint(prefix, id, isReset, totalParts) {
        if(!auth.currentUser) return alert("Bitte erst einloggen!");
        
        // Pfad ermitteln
        let rootPath = 'maintenanceState'; // Default Agie
        let offKey = 'agieOffsets';
        if(prefix === 'U') { rootPath = 'maintenanceStateUnotron'; offKey = 'unotronOffsets'; }
        if(prefix === 'H') { rootPath = 'maintenanceStateHE'; offKey = 'heOffsets'; }

        if(isReset) {
            // AUSTAUSCH LOGIK
            if(!confirm(`${prefix}-${id}: Austausch/Reset best√§tigen?`)) return;
            await db.ref(`${rootPath}/${offKey}/${id}`).set(totalParts); // Offset setzen
            await db.ref(`${rootPath}/extraCycles/${id}`).set(0);       // Zyklen reset
        } else {
            // NORMALER ZYKLUS +1
            const ref = db.ref(`${rootPath}/extraCycles/${id}`);
            const snap = await ref.once('value');
            await ref.set((snap.val() || 0) + 1);
        }
        // Einsteller entfernen
        await db.ref(`dashboardAssignments/${prefix}${id}`).set("");
    }

    // --- STANDARD FUNKTIONEN ---
    function formatTotalTime(m) { if(m<=0)return""; if(m<60)return m+" Min."; const h=Math.floor(m/60); if(h<24)return(m%60)>0?`${h}h ${m%60}m`:`${h}h`; return Math.floor(h/24)+"T "+(h%24)+"h"; }
    function getDuration(p, t) { if(!p||p.includes("RESET")||!t)return 0; return p.split('/').reduce((a,c)=>{let k=c.toUpperCase().trim(); if(!k.startsWith("P"))k="P"+k; return a+(t[k]||0);},0); }
    function resetInactivityTimer() { clearTimeout(inactivityTimer); if(auth.currentUser) inactivityTimer=setTimeout(()=>auth.signOut(),180000); }
    function toggleAuthModal(){ if(auth.currentUser){auth.signOut();return;} document.getElementById('authModal').style.display='flex'; }
    function switchAuthMode(){ state.isRegMode=!state.isRegMode; document.getElementById('modalTitle').innerText=state.isRegMode?"Registrieren":"Login"; document.getElementById('mainAuthBtn').innerText=state.isRegMode?"Account erstellen":"Anmelden"; document.getElementById('inviteGroup').style.display=state.isRegMode?"block":"none"; }
    async function processAuth(){ const e=document.getElementById('authEmail').value,p=document.getElementById('authPass').value; if(state.isRegMode){ const i=document.getElementById('authInvite').value, s=await db.ref('config/inviteCode').once('value'); if(i!==s.val())return alert("Code falsch!"); auth.createUserWithEmailAndPassword(e,p).then(()=>location.reload()).catch(e=>alert(e.message)); }else{ auth.signInWithEmailAndPassword(e,p).then(()=>document.getElementById('authModal').style.display='none').catch(e=>alert(e.message)); } }
    // --- ADMIN / EINSTELLER LOGIK ---

    function openAdminModal() {
        document.getElementById('adminModal').style.display = 'flex';
        // Reset View
        document.getElementById('adminLoginView').style.display = 'block';
        document.getElementById('adminManagerView').style.display = 'none';
        document.getElementById('adminPWInput').value = '';
    }

    function closeAdminModal() {
        document.getElementById('adminModal').style.display = 'none';
    }

    async function checkAdminPW() {
        const input = document.getElementById('adminPWInput').value;
        const snap = await db.ref('config/adminPW').once('value');
        const realPW = snap.val();

        if (input === realPW) {
            document.getElementById('adminLoginView').style.display = 'none';
            document.getElementById('adminManagerView').style.display = 'block';
            renderAdminList();
        } else {
            alert("Falsches Passwort!");
        }
    }

    function renderAdminList() {
        const list = state.config.einstellerListe || [];
        // Sortieren nach Nachname (String Vergleich)
        list.sort((a, b) => a.localeCompare(b));

        const ul = document.getElementById('adminEinstellerList');
        ul.innerHTML = list.map(name => {
            // Formatierung: "D√ºtsch Bernd" -> "D√ºtsch Be."
            const parts = name.split(' ');
            let display = name;
            if (parts.length >= 2) {
                const nachname = parts[0];
                const vorname = parts.slice(1).join(' '); // Falls Vorname aus mehreren Teilen besteht
                display = `<b>${nachname}</b> ${vorname.substring(0, 2)}.`;
            }
            return `<li>${display}</li>`;
        }).join('');
    }

    async function addEinsteller() {
        const n = document.getElementById('newNachname').value.trim();
        const v = document.getElementById('newVorname').value.trim();

        if (!n || !v) return alert("Bitte Vor- und Nachnamen eingeben.");

        // Speichern als "Nachname Vorname"
        const fullName = `${n} ${v}`;
        const currentList = state.config.einstellerListe || [];

        // Duplikat Check
        if (currentList.includes(fullName)) {
            return alert("Dieser Mitarbeiter existiert bereits!");
        }

        const newList = [...currentList, fullName];
        
        try {
            await db.ref('config/einstellerListe').set(newList);
            // Felder leeren und Liste neu rendern
            document.getElementById('newNachname').value = '';
            document.getElementById('newVorname').value = '';
            renderAdminList(); // UI Update sofort (Firebase Listener macht es im Hintergrund auch)
        } catch (e) {
            alert("Fehler beim Speichern: " + e.message);
        }
    }

    // --- DATA ---
    db.ref('maintenanceConfig').on('value', s => { state.maintConfig = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.agie = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.uno = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.he = s.val() || {}; updateUI(); });
    db.ref('dashboardAssignments').on('value', s => { state.assignments = s.val() || {}; updateUI(); });
    db.ref('config').on('value', s => { state.config = s.val() || {}; updateUI(); });
    auth.onAuthStateChanged(u => { document.getElementById('authBtn').innerText = u ? "üîì Logout" : "üîë Login"; updateUI(); });

    function updateUI() { if(!state.maintConfig.agie) return; renderCol('list-agie', 'count-agie', state.agie, 'A', state.maintConfig.agie); renderCol('list-uno', 'count-uno', state.uno, 'U', state.maintConfig.unotron); renderCol('list-he', 'count-he', state.he, 'H', state.maintConfig.he); }

    function renderCol(listId, countId, rawData, prefix, machineCfg) {
        if(!rawData || !rawData.cloudRawData || !machineCfg) return;
        let totalMin = 0;
        const data = rawData.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO; if(!sId) return null;
            const cyc = (rawData.extraCycles && rawData.extraCycles[sId]) || 0;
            const offK = prefix==='A'?'agieOffsets':(prefix==='H'?'heOffsets':'unotronOffsets');
            const ist = (parseInt(item.Parts || item["COUNT(*)"]) || 0) - ((rawData[offK] && rawData[offK][sId]) || 0);
            const step = machineCfg.steps[cyc] || { target: machineCfg.maxLimit, pkg: "RESET" };
            
            const isOverMax = ist >= machineCfg.maxLimit;
            const rest = (isOverMax ? machineCfg.maxLimit : step.target) - ist;
            const dur = getDuration(isOverMax ? "RESET" : step.pkg, machineCfg.times);
            
            if(rest < machineCfg.warn) totalMin += dur;

            return { 
                id: prefix+"-"+sId, sId, rest, 
                pkg: isOverMax ? "WP RESET" : step.pkg, 
                dur, warn: machineCfg.warn, crit: machineCfg.crit,
                isReset: isOverMax, 
                rawTotal: (parseInt(item.Parts || item["COUNT(*)"]) || 0) // F√ºr Reset n√∂tig
            };
        }).filter(m => m && m.rest < m.warn).sort((a,b) => a.rest - b.rest);

        document.getElementById(countId).innerHTML = `<span>${data.length}</span> ` + (totalMin > 0 ? `<span class="time-badge">‚è≥ ${formatTotalTime(totalMin)}</span>` : "");
        
        document.getElementById(listId).innerHTML = data.map(m => {
            const ass = state.assignments[prefix+m.sId] || "";
            const isW = ass !== "";
            let cls = 'warning'; let icon = '';
            if(m.rest <= 0) { 
                if(!isW) { cls='overdue'; icon='‚ö†Ô∏è '; } else cls='overdue'; 
            } else if(m.rest < m.crit) cls='critical';

            // Button Logik: Nur aktivieren wenn Schwellwert erreicht (rest < warn)
            const isDisabled = m.rest > m.warn; 
            const btnClass = m.isReset ? 'btn-done reset-mode' : 'btn-done';
            const btnText = m.isReset ? 'üîÑ Austausch' : '‚úÖ Erledigt';

            return `
            <div class="card ${cls} ${isW?'in-progress':''}">
                <div class="card-info">
                    <div><div class="m-id">${m.id}</div><div class="m-paket">${icon}${m.pkg}</div><div class="m-time">‚è± ${m.dur} Min.</div></div>
                    <div class="m-rest">${m.rest.toLocaleString()}</div>
                </div>
                <div class="card-actions">
                    <select ${!auth.currentUser?'disabled':''} onchange="db.ref('dashboardAssignments/${prefix}${m.sId}').set(this.value)">
                        <option value="">-- Einsteller --</option>
                        ${(state.config.einstellerListe||[]).map(e => `<option value="${e}" ${ass===e?'selected':''}>${e}</option>`).join('')}
                    </select>
                    <button class="${btnClass}" 
                        ${isDisabled || !auth.currentUser ? 'disabled' : ''} 
                        onclick="confirmMaint('${prefix}', '${m.sId}', ${m.isReset}, ${m.rawTotal})">
                        ${btnText}
                    </button>
                </div>
            </div>`;
        }).join('');
    }
</script>
</body>
</html>
