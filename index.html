<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; 
            --bosch-gray: #eff1f2; --bosch-dark-red: #8b0000; --bosch-work-yellow: #fff3cd; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* Navigation & Layout */
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        
        /* Zeit & Karten */
        .time-badge { font-size: 0.8em; color: var(--bosch-red); background: #ffeeee; padding: 2px 8px; border-radius: 12px; border: 1px solid #ffcccc; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .card { padding: 12px; border-bottom: 1px solid #eee; border-left: 8px solid #ccc; margin-bottom: 8px; background: #fff; }
        .card.warning { border-left-color: #ffa500; } 
        .card.critical { border-left-color: var(--bosch-red); } 
        .card.overdue { border-left-color: var(--bosch-dark-red); }
        .card.in-progress { background: var(--bosch-work-yellow) !important; border-left-style: dashed; }
        
        /* Modale & Formulare */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; padding: 25px; width: 350px; border-top: 8px solid var(--bosch-red); border-radius: 4px; }
        .modal-box h2 { margin-top: 0; color: var(--bosch-blue); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85em; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); }
        .primary-btn { background: var(--bosch-blue); color: white; border: none; width: 100%; padding: 10px; cursor: pointer; font-weight: bold; }
        .link-btn { background: none; border: none; color: var(--bosch-blue); text-decoration: underline; cursor: pointer; font-size: 0.85em; margin-top: 10px; display: block; width: 100%; text-align: center; }
        
        #timeout-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #ddd; }
        #timeout-bar { height: 100%; width: 0%; background: var(--bosch-red); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .blink { animation: blink 1s infinite; }
    </style>
</head>
<body onmousedown="resetInactivityTimer()" onkeydown="resetInactivityTimer()">

<div class="top-bar">Zentrales Wartungs Dashboard W430</div>

<div class="header">
    <div><span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> <span style="font-weight:bold;margin-left:10px;color:#555;">Dashboard</span></div>
    <div style="display:flex; gap:10px;">
        <button id="authBtn" class="nav-btn" onclick="toggleAuthModal()">üîë Login</button>
        <button class="nav-btn" onclick="openAdminModal()">‚öôÔ∏è Einsteller</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="column"><div class="col-header"><span>‚ö° Agie</span><div id="count-agie">0</div></div><div class="machine-list" id="list-agie"></div></div>
    <div class="column" style="border-top-color: var(--bosch-green);"><div class="col-header"><span>üß™ Unotron</span><div id="count-uno">0</div></div><div class="machine-list" id="list-uno"></div></div>
    <div class="column" style="border-top-color: #007bc0;"><div class="col-header"><span>‚öôÔ∏è HE</span><div id="count-he">0</div></div><div class="machine-list" id="list-he"></div></div>
</div>

<div id="timeout-bar-container"><div id="timeout-bar"></div></div>

<div id="authModal" class="modal">
    <div class="modal-box">
        <h2 id="modalTitle">Login</h2>
        <div class="form-group"><label>E-Mail</label><input type="email" id="authEmail"></div>
        <div class="form-group"><label>Passwort</label><input type="password" id="authPass"></div>
        <div class="form-group" id="inviteGroup" style="display:none;"><label>Einladungscode</label><input type="text" id="authInvite"></div>
        <button class="primary-btn" id="mainAuthBtn" onclick="processAuth()">Anmelden</button>
        <button class="link-btn" id="switchBtn" onclick="switchAuthMode()">Neu hier? Registrieren</button>
        <button class="link-btn" style="color:gray; text-decoration:none;" onclick="toggleAuthModal()">Abbrechen</button>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", 
        authDomain: "bosch-agie-wartung.firebaseapp.com", 
        databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "bosch-agie-wartung" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    let state = { config:{}, assignments:{}, agie:{}, uno:{}, he:{}, maintConfig: {}, isRegMode: false };
    let inactivityTimer;

    // --- AUTH LOGIK ---

    function toggleAuthModal() {
        if(auth.currentUser) { auth.signOut(); return; }
        document.getElementById('authModal').style.display = 'flex';
    }

    function switchAuthMode() {
        state.isRegMode = !state.isRegMode;
        document.getElementById('modalTitle').innerText = state.isRegMode ? "Registrieren" : "Login";
        document.getElementById('mainAuthBtn').innerText = state.isRegMode ? "Account erstellen" : "Anmelden";
        document.getElementById('switchBtn').innerText = state.isRegMode ? "Schon ein Konto? Login" : "Neu hier? Registrieren";
        document.getElementById('inviteGroup').style.display = state.isRegMode ? "block" : "none";
    }

    async function processAuth() {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const invite = document.getElementById('authInvite').value;

        try {
            if(state.isRegMode) {
                // Code aus Firebase holen
                const snap = await db.ref('config/inviteCode').once('value');
                if(invite !== snap.val()) { alert("Falscher Einladungscode!"); return; }
                await auth.createUserWithEmailAndPassword(email, pass);
                alert("Konto erstellt!");
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
            }
            document.getElementById('authModal').style.display = 'none';
        } catch (e) { alert("Fehler: " + e.message); }
    }

    // --- HILFSFUNKTIONEN ---

    function formatTotalTime(totalMinutes) {
        if (totalMinutes <= 0) return "";
        if (totalMinutes < 60) return totalMinutes + " Min.";
        const hours = Math.floor(totalMinutes / 60);
        const mins = totalMinutes % 60;
        if (hours < 24) return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        const days = Math.floor(hours / 24);
        const remH = hours % 24;
        return remH > 0 ? `${days}T ${remH}h` : `${days}T`;
    }

    function getDuration(pkgString, timeTable) {
        if (!pkgString || pkgString.includes("RESET") || !timeTable) return 0;
        return pkgString.split('/').reduce((acc, p) => {
             let key = p.toUpperCase().trim(); 
             if(!key.startsWith("P")) key = "P" + key;
             return acc + (timeTable[key] || 0);
        }, 0);
    }

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        if(auth.currentUser) {
            inactivityTimer = setTimeout(() => auth.signOut(), 120000); // Erh√∂ht auf 2 Min
        }
    }

    // --- DATA HANDLING ---

    db.ref('maintenanceConfig').on('value', s => { state.maintConfig = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.agie = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.uno = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.he = s.val() || {}; updateUI(); });
    db.ref('dashboardAssignments').on('value', s => { state.assignments = s.val() || {}; updateUI(); });
    db.ref('config').on('value', s => { state.config = s.val() || {}; updateUI(); });

    auth.onAuthStateChanged(user => { 
        document.getElementById('authBtn').innerText = user ? "üîì Logout ("+user.email.split('@')[0]+")" : "üîë Login";
        updateUI();
    });

    function updateUI() {
        if(!state.maintConfig.agie) return; 
        renderCol('list-agie', 'count-agie', state.agie, 'A', state.maintConfig.agie);
        renderCol('list-uno', 'count-uno', state.uno, 'U', state.maintConfig.unotron);
        renderCol('list-he', 'count-he', state.he, 'H', state.maintConfig.he);
    }

    function renderCol(listId, countId, rawData, prefix, machineCfg) {
        if(!rawData || !rawData.cloudRawData || !machineCfg) return;
        let totalMin = 0;

        const data = rawData.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO;
            if(!sId) return null;
            const cyc = (rawData.extraCycles && rawData.extraCycles[sId]) || 0;
            const offKey = prefix==='A'?'agieOffsets':(prefix==='H'?'heOffsets':'unotronOffsets');
            const ist = (parseInt(item.Parts || item["COUNT(*)"]) || 0) - ((rawData[offKey] && rawData[offKey][sId]) || 0);
            const step = machineCfg.steps[cyc] || { target: machineCfg.maxLimit, pkg: "RESET" };
            const rest = (ist >= machineCfg.maxLimit ? machineCfg.maxLimit : step.target) - ist;
            const dur = getDuration(ist >= machineCfg.maxLimit ? "RESET" : step.pkg, machineCfg.times);
            if(rest < machineCfg.warn) totalMin += dur;

            return { id: prefix+"-"+sId, key: prefix+sId, rest, pkg: step.pkg, dur, warn: machineCfg.warn, crit: machineCfg.crit };
        }).filter(m => m && m.rest < m.warn).sort((a,b) => a.rest - b.rest);

        const timeStr = totalMin > 0 ? `<span class="time-badge">‚è≥ ${formatTotalTime(totalMin)}</span>` : "";
        document.getElementById(countId).innerHTML = `<span style="margin-right:8px">${data.length}</span> ${timeStr}`;

        document.getElementById(listId).innerHTML = data.map(m => {
            const ass = state.assignments[m.key] || "";
            const isW = ass !== "";
            const cls = (m.rest <= 0 && !isW) ? 'blink overdue' : (m.rest <= 0 ? 'overdue' : (m.rest < m.crit ? 'critical' : 'warning'));
            return `
            <div class="card ${cls} ${isW?'in-progress':''}">
                <div class="card-info">
                    <div><b>${m.id}</b><br><span class="m-paket">${m.pkg}</span><br><span class="m-time">‚è± ${m.dur} Min.</span></div>
                    <div style="text-align:right"><b>${m.rest.toLocaleString()}</b></div>
                </div>
                <select ${!auth.currentUser?'disabled':''} onchange="db.ref('dashboardAssignments/${m.key}').set(this.value)">
                    <option value="">-- Einsteller --</option>
                    ${(state.config.einstellerListe||[]).map(e => `<option value="${e}" ${ass===e?'selected':''}>${e}</option>`).join('')}
                </select>
            </div>`;
        }).join('');
    }

    function openAdminModal() {
        if(!auth.currentUser) return alert("Bitte erst einloggen!");
        const current = (state.config.einstellerListe || []).join('\n');
        const next = prompt("Einsteller-Liste (einer pro Zeile):", current);
        if(next !== null) db.ref('config/einstellerListe').set(next.split('\n').map(s => s.trim()).filter(s => s !== ""));
    }
</script>
</body>
</html>
