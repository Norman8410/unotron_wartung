<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-workload { background: var(--bosch-blue); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.1em; margin-left: 20px;}
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; padding: 20px; flex: 1; overflow-y: auto; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; min-height: 400px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: var(--bosch-blue); display: flex; align-items: center; gap: 5px; }
        .col-header a:hover { color: var(--bosch-red); }
        .time-badge { font-size: 0.8em; color: var(--bosch-red); background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #ffcccc; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .no-data { text-align: center; color: #999; padding-top: 50px; font-style: italic; }
        .card { padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #eee; }
        .card.warning { background-color: #fff3cd; border-left: 8px solid #ffc107; }
        .card.critical { background-color: #f8d7da; border-left: 8px solid #dc3545; }
        .card.overdue { background-color: #f5b7b1; border-left: 8px solid #b03a2e; }
        .card.in-progress { background-color: #d1ecf1 !important; border-left: 8px dashed #0c5460 !important; }
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .m-id { font-weight: bold; font-size: 1.2em; } .m-rest { font-weight: bold; font-size: 1.2em; } .m-paket { font-size: 0.9em; font-weight: bold; }
        .card-actions { display: flex; gap: 5px; margin-top: 8px; }
        select { flex: 1; padding: 6px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; background: white; }
        .btn-done { flex: 0 0 auto; padding: 0 10px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; font-weight: bold; cursor: pointer; background: white; color: var(--bosch-green); }
        .btn-done.reset-mode { color: var(--bosch-red); border-color: var(--bosch-red); }
        .btn-done:disabled { opacity: 0.4; cursor: not-allowed; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); border-radius: 4px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; padding: 25px; width: 350px; border-top: 8px solid var(--bosch-red); border-radius: 4px; }
        .form-group { margin-bottom: 15px; } .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .primary-btn { background: var(--bosch-blue); color: white; border: none; width: 100%; padding: 12px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        .link-btn { background: none; border: none; color: var(--bosch-blue); text-decoration: underline; cursor: pointer; margin-top: 15px; display: block; width: 100%; text-align: center; }
    </style>
</head>
<body>

<div class="top-bar">Zentrales Wartungs Dashboard W430</div>
<div class="header">
    <div style="display:flex; align-items:center;">
        <span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> 
        <div id="overall-workload" class="total-workload">Lade...</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="authBtn" class="nav-btn" onclick="toggleAuthModal()">üîë Login</button>
        <button class="nav-btn" onclick="openAdminModal()">‚öôÔ∏è Einsteller</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="column"><div class="col-header"><a href="agie.html" target="_blank">‚ö° Agie <span>‚ûî</span></a><div id="count-agie"></div></div><div class="machine-list" id="list-agie"></div></div>
    <div class="column"><div class="col-header"><a href="unotron.html" target="_blank">üß™ Unotron <span>‚ûî</span></a><div id="count-uno"></div></div><div class="machine-list" id="list-uno"></div></div>
    <div class="column"><div class="col-header"><a href="he.html" target="_blank">‚öôÔ∏è HE <span>‚ûî</span></a><div id="count-he"></div></div><div class="machine-list" id="list-he"></div></div>
    <div class="column"><div class="col-header"><a href="unotron-auto.html" target="_blank">ü§ñ Unotron Auto <span>‚ûî</span></a><div id="count-uno-auto"></div></div><div class="machine-list" id="list-uno-auto"></div></div>
    <div class="column"><div class="col-header"><a href="laser.html" target="_blank">üí° Laser <span>‚ûî</span></a><div id="count-laser"></div></div><div class="machine-list" id="list-laser"></div></div>
    <div class="column" style="border-top-color: #17a2b8;"><div class="col-header"><a href="waschanlagen.html" target="_blank">üíß Waschanlagen <span>‚ûî</span></a><div id="count-wasch"></div></div><div class="machine-list" id="list-wasch"></div></div>
    <div class="column" style="border-top-color: #fd7e14;"><div class="col-header"><a href="pruefgeraete.html" target="_blank">üîç Pr√ºfger√§te <span>‚ûî</span></a><div id="count-pruef"></div></div><div class="machine-list" id="list-pruef"></div></div>
    <div class="column" style="border-top-color: #6f42c1;"><div class="col-header"><a href="lager.html" target="_blank">üì¶ Lager & Regale <span>‚ûî</span></a><div id="count-lager"></div></div><div class="machine-list" id="list-lager"></div></div>
</div>

<div id="authModal" class="modal"><div class="modal-box"><h2 id="modalTitle" style="margin-top:0;">Login</h2><div id="authError" style="color:red; margin-bottom:10px; min-height:18px;"></div><div class="form-group"><input type="text" id="authIdentifier" placeholder="Benutzername oder E-Mail"></div><div class="form-group" id="userGroup" style="display:none;"><input type="text" id="authUsername" placeholder="Benutzername"></div><div id="emailGroup" style="display:none;" class="form-group"><input type="email" id="authEmail" placeholder="E-Mail"></div><div class="form-group"><input type="password" id="authPass" placeholder="Passwort"></div><div id="inviteGroup" style="display:none;" class="form-group"><input type="text" id="authInvite" placeholder="Einladungscode"></div><button class="primary-btn" id="mainAuthBtn" onclick="processAuth()">Anmelden</button><button class="link-btn" id="switchBtn" onclick="switchAuthMode()">Neu hier? Registrieren</button><button class="link-btn" style="color:gray; text-decoration:none;" onclick="closeAuthModal()">Abbrechen</button></div></div>
<div id="adminModal" class="modal"><div class="modal-box" style="width: 400px;"><h2 style="margin-top:0;">Einsteller Verwaltung</h2><div id="adminLoginView"><div class="form-group"><label>Admin-Passwort</label><input type="password" id="AdminPWInput" placeholder="Passwort eingeben"></div><button class="primary-btn" onclick="checkAdminPW()">Entsperren</button></div><div id="adminManagerView" style="display:none;"><div style="max-height: 200px; overflow-y: auto; background: #f9f9f9; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px;"><ul id="adminEinstellerList" style="list-style: none; padding: 0; margin: 0;"></ul></div><div style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="text" id="newNachname" placeholder="Nachname" style="flex: 1;"><input type="text" id="newVorname" placeholder="Vorname" style="flex: 1;"></div><button class="primary-btn" style="background: var(--bosch-green);" onclick="addEinsteller()">‚ûï Hinzuf√ºgen</button></div><button class="link-btn" style="color:gray; text-decoration:none;" onclick="closeAdminModal()">Schlie√üen</button></div></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    
    let state = { config: {}, assignments: {}, maintConfig: {}, maintenanceState: {}, maintenanceStateHE: {}, maintenanceStateUnotron: {}, maintenanceStateUnotronAuto: {}, maintenanceStateLaser: {}, maintenanceStateKW: {}, isRegMode: false };

    const kwGroups = {
        wasch: ['silberhorn', 'ministar'],
        pruef: ['sichtpruefstaende', 'sichtpruefplaetze', 'einstellgeraetNek'],
        lager: ['unotronAblieferregal', 'entkopplungsregal', 'waschregal', 'oellager']
    };

    // --- DATEN-LISTENER ---
    db.ref('config').on('value', s => { state.config = s.val() || {}; updateUI(); });
    db.ref('assignments').on('value', s => { state.assignments = s.val() || {}; updateUI(); });
    db.ref('maintenanceConfig').on('value', s => { state.maintConfig = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.maintenanceState = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.maintenanceStateHE = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.maintenanceStateUnotron = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotronAuto').on('value', s => { state.maintenanceStateUnotronAuto = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateLaser').on('value', s => { state.maintenanceStateLaser = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateKW').on('value', s => { state.maintenanceStateKW = s.val() || {}; updateUI(); });
    auth.onAuthStateChanged(user => { document.getElementById('authBtn').innerText = user ? 'üîì Logout' : 'üîë Login'; updateUI(); });

    // --- HILFSFUNKTIONEN ---
    function getDuration(p, t) { if(!p||p.includes("RESET")||!t)return 0; return p.split(/[\s\/]+/).reduce((a,c)=>{let k=c.toUpperCase().trim(); if(k&&!k.startsWith("P"))k="P"+k; return a+(t[k]||0);},0); }
    function formatTime(m){ if(m<=0)return"0m"; const d=Math.floor(m/1440),h=Math.floor((m%1440)/60),min=m%60; let p=[]; if(d>0)p.push(d+'d'); if(h>0)p.push(h+'h'); if(min>0||p.length===0)p.push(min+'m'); return p.join(' '); }
    function getWeek() { const d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()+3-(d.getDay()+6)%7); const w1=new Date(d.getFullYear(),0,4); return 1+Math.round(((d-w1)/86400000-3+(w1.getDay()+6)%7)/7); }
    
    // --- AUTH & MODAL FUNKTIONEN ---
    function toggleAuthModal() { if (auth.currentUser) { auth.signOut(); } else { document.getElementById('authModal').style.display = 'flex'; } }
    function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }
    function switchAuthMode() {
        state.isRegMode = !state.isRegMode;
        document.getElementById('modalTitle').innerText = state.isRegMode ? "Registrieren" : "Login";
        document.getElementById('mainAuthBtn').innerText = state.isRegMode ? "Account erstellen" : "Anmelden";
        document.getElementById('switchBtn').innerText = state.isRegMode ? "Zum Login" : "Neu hier? Registrieren";
        document.getElementById('userGroup').style.display = state.isRegMode ? "block" : "none";
        document.getElementById('emailGroup').style.display = state.isRegMode ? "block" : "none";
        document.getElementById('inviteGroup').style.display = state.isRegMode ? "block" : "none";
        document.getElementById('authIdentifier').parentElement.style.display = state.isRegMode ? "none" : "block";
    }
    async function processAuth() { /* ... Logik aus index (1).html ... */ }
    function openAdminModal() { document.getElementById('adminModal').style.display = 'flex'; }
    function closeAdminModal() { document.getElementById('adminModal').style.display = 'none'; }
    async function checkAdminPW() { /* ... */ }
    function renderAdminList() { /* ... */ }
    async function addEinsteller() { /* ... */ }
    async function handleEinstellerChange(prefix, sId, val) {
        if (!auth.currentUser) return; 
        const fullId = prefix + sId; 
        if (!val) { await db.ref(`assignments/${fullId}`).set(""); return; } 
        await db.ref(`assignments/${fullId}`).set(val);
    }
    async function confirmMaint(prefix, id, isReset, total) {
        if (!auth.currentUser) return;
        const rootNode = prefix === 'A-' ? 'maintenanceState' : `maintenanceState${prefix.replace('-', '')}`;
        const offset
